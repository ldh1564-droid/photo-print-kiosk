<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ì…€í”„ í¬í†  í”„ë¦°íŠ¸</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --primary: #4A90D9;
    --primary-dark: #357ABD;
    --bg: #f5f5f7;
    --card: #ffffff;
    --text: #1d1d1f;
    --text-light: #86868b;
    --radius: 16px;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    -webkit-tap-highlight-color: transparent;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    text-align: center;
    padding: 32px 20px 16px;
  }
  .header h1 {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .header p {
    color: var(--text-light);
    font-size: 14px;
    margin-top: 4px;
  }

  /* â”€â”€ Screens â”€â”€ */
  .screen { display: none; }
  .screen.active { display: block; }

  /* â”€â”€ Home â”€â”€ */
  .home-buttons {
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 20px;
    max-width: 400px;
    margin: 0 auto;
  }
  .home-btn {
    display: flex;
    align-items: center;
    gap: 16px;
    background: var(--card);
    border: none;
    border-radius: var(--radius);
    padding: 24px;
    font-size: 17px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: transform 0.2s, box-shadow 0.2s;
    text-align: left;
  }
  .home-btn:active { transform: scale(0.97); }
  .home-btn .icon {
    width: 52px; height: 52px;
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }
  .home-btn .icon.camera { background: #e8f0fe; }
  .home-btn .icon.upload { background: #fef3e8; }
  .home-btn .desc {
    font-size: 13px;
    font-weight: 400;
    color: var(--text-light);
    margin-top: 2px;
  }

  /* â”€â”€ Camera â”€â”€ */
  .camera-wrap {
    position: relative;
    max-width: 100%;
    margin: 0 auto;
    padding: 10px;
  }
  #videoPreview {
    width: 100%;
    border-radius: var(--radius);
    background: #000;
    display: block;
    max-height: 75vh;
    object-fit: cover;
  }
  .camera-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 24px;
    margin-top: 20px;
  }
  .shutter-btn {
    width: 72px; height: 72px;
    border-radius: 50%;
    border: 4px solid var(--primary);
    background: white;
    cursor: pointer;
    position: relative;
    transition: transform 0.15s;
  }
  .shutter-btn::after {
    content: '';
    position: absolute;
    inset: 4px;
    border-radius: 50%;
    background: var(--primary);
    transition: transform 0.15s;
  }
  .shutter-btn:active::after { transform: scale(0.85); }
  .switch-btn, .back-btn-cam {
    width: 44px; height: 44px;
    border-radius: 50%;
    border: none;
    background: rgba(0,0,0,0.06);
    font-size: 20px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  /* â”€â”€ Editor â”€â”€ */
  .editor-wrap {
    max-width: 500px;
    margin: 0 auto;
    padding: 20px;
  }
  .canvas-container {
    position: relative;
    width: 100%;
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }
  #photoCanvas {
    max-width: 100%;
    max-height: 55vh;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }

  .section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Frame selector */
  .frame-selector {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 8px;
    margin-bottom: 20px;
    -webkit-overflow-scrolling: touch;
  }
  .frame-option {
    flex-shrink: 0;
    width: 72px; height: 72px;
    border-radius: 12px;
    border: 3px solid transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
    background: var(--card);
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: border-color 0.2s, transform 0.15s;
    text-align: center;
    padding: 4px;
  }
  .frame-option.selected {
    border-color: var(--primary);
    transform: scale(1.05);
  }
  .frame-option .frame-preview {
    width: 40px; height: 40px;
    margin-bottom: 2px;
  }

  /* Text input */
  .text-section { margin-bottom: 20px; }
  .text-input-row {
    display: flex;
    gap: 8px;
  }
  .text-input-row input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e5e5ea;
    border-radius: 12px;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
  }
  .text-input-row input:focus { border-color: var(--primary); }
  .text-input-row select {
    padding: 12px;
    border: 2px solid #e5e5ea;
    border-radius: 12px;
    font-size: 14px;
    background: white;
    outline: none;
  }
  .text-color-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    align-items: center;
  }
  .color-dot {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: transform 0.15s, border-color 0.2s;
  }
  .color-dot.selected {
    border-color: var(--primary);
    transform: scale(1.15);
  }

  /* Buttons */
  .action-row {
    display: flex;
    gap: 12px;
    margin-top: 10px;
  }
  .btn {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.2s;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  .btn-secondary {
    background: #e5e5ea;
    color: var(--text);
  }
  .save-hint {
    text-align: center;
    font-size: 13px;
    color: var(--text-light);
    margin-top: 12px;
  }

  /* â”€â”€ Print Area â”€â”€ */
  #printArea {
    display: none;
  }

  /* â”€â”€ File input â”€â”€ */
  #fileInput { display: none; }

  /* â”€â”€ Responsive â”€â”€ */
  @media (min-width: 768px) {
    .header h1 { font-size: 30px; }
    .home-buttons { flex-direction: row; max-width: 600px; }
    .home-btn { flex: 1; flex-direction: column; text-align: center; padding: 32px 20px; }
  }

  /* â”€â”€ Print styles â”€â”€ */
  @media print {
    body * { visibility: hidden !important; }
    #printArea, #printArea * {
      visibility: visible !important;
    }
    #printArea {
      display: block !important;
      position: fixed;
      left: 0; top: 0;
      width: 100%;
      height: 100%;
      display: flex !important;
      align-items: center;
      justify-content: center;
      background: white;
    }
    #printArea img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    @page {
      margin: 10mm;
      size: auto;
    }
  }
</style>
</head>
<body>

<!-- ====== HOME ====== -->
<div id="homeScreen" class="screen active">
  <div class="header">
    <h1>ì…€í”„ í¬í†  í”„ë¦°íŠ¸</h1>
    <p>ì‚¬ì§„ì„ ì°ê±°ë‚˜ ê³¨ë¼ì„œ í”„ë¦°íŠ¸í•˜ì„¸ìš”</p>
  </div>
  <div class="home-buttons">
    <button class="home-btn" onclick="openCamera()">
      <div class="icon camera">&#128247;</div>
      <div>
        ì‚¬ì§„ ì´¬ì˜
        <div class="desc">ì¹´ë©”ë¼ë¡œ ì§ì ‘ ì´¬ì˜í•©ë‹ˆë‹¤</div>
      </div>
    </button>
    <button class="home-btn" onclick="openUpload()">
      <div class="icon upload">&#128193;</div>
      <div>
        ì‚¬ì§„ ì—…ë¡œë“œ
        <div class="desc">ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚¬ì§„ì„ ì„ íƒí•©ë‹ˆë‹¤</div>
      </div>
    </button>
  </div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<!-- ====== CAMERA ====== -->
<div id="cameraScreen" class="screen">
  <div class="header">
    <h1>ì‚¬ì§„ ì´¬ì˜</h1>
  </div>
  <div class="camera-wrap">
    <video id="videoPreview" autoplay playsinline></video>
    <div class="camera-controls">
      <button class="back-btn-cam" onclick="closeCamera()" title="ë’¤ë¡œ">&#9664;</button>
      <button class="shutter-btn" onclick="capturePhoto()"></button>
      <button class="switch-btn" onclick="switchCamera()" title="ì¹´ë©”ë¼ ì „í™˜">&#128260;</button>
    </div>
  </div>
</div>

<!-- ====== EDITOR ====== -->
<div id="editorScreen" class="screen">
  <div class="header">
    <h1>ì‚¬ì§„ í¸ì§‘</h1>
  </div>
  <div class="editor-wrap">
    <div class="canvas-container">
      <canvas id="photoCanvas"></canvas>
    </div>

    <div class="section-title">í”„ë ˆì„</div>
    <div class="frame-selector" id="frameSelector"></div>

    <div class="section-title">ë°ê¸°</div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;">
      <span style="font-size:20px;">ğŸŒ‘</span>
      <input type="range" id="brightnessRange" min="-50" max="50" value="0" oninput="renderCanvas()" style="flex:1;height:6px;">
      <span style="font-size:20px;">â˜€ï¸</span>
    </div>

    <div class="text-section">
      <div class="section-title">í…ìŠ¤íŠ¸</div>
      <div class="text-input-row">
        <input type="text" id="textInput" placeholder="ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="40" oninput="renderCanvas()">
        <select id="textPosition" onchange="renderCanvas()">
          <option value="bottom">í•˜ë‹¨</option>
          <option value="top">ìƒë‹¨</option>
          <option value="center">ì¤‘ì•™</option>
        </select>
      </div>
      <div class="text-color-row">
        <span style="font-size:13px;color:var(--text-light);margin-right:4px;">ìƒ‰ìƒ:</span>
        <div class="color-dot selected" style="background:#fff;box-shadow:inset 0 0 0 1px #ccc" data-color="#ffffff" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#000" data-color="#000000" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#ff3b5c" data-color="#ff3b5c" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#ffcc00" data-color="#ffcc00" onclick="selectColor(this)"></div>
        <div class="color-dot" style="background:#34c759" data-color="#34c759" onclick="selectColor(this)"></div>
      </div>
    </div>

    <div class="action-row">
      <button class="btn btn-secondary" onclick="goHome()">ì²˜ìŒìœ¼ë¡œ</button>
      <button class="btn btn-primary" onclick="savePhoto()">ì‚¬ì§„ ì €ì¥</button>
      <button class="btn btn-primary" style="background:#34c759" onclick="printPhoto()">í”„ë¦°íŠ¸</button>
    </div>
  </div>
</div>

<!-- Print target -->
<div id="printArea">
  <img id="printImage">
</div>

<script>
// â”€â”€ Supabase â”€â”€
const SUPABASE_URL = 'https://czvaoseccmeosvzawryf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dmFvc2VjY21lb3N2emF3cnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MzA0OTIsImV4cCI6MjA4NTMwNjQ5Mn0.Wy_Izc_Ggfa9FZ-EPLJ9RY4i_fLhlcxZoFuRsjMrfow';

// â”€â”€ State â”€â”€
let originalImage = null;
let currentFrame = 'hachiware';
let textColor = '#ffffff';
let facingMode = 'environment';
let stream = null;

// â”€â”€ Frame definitions â”€â”€
const frames = [
  { id: 'hachiware', name: 'í•˜ì¹˜ì™€ë ˆ',   border: 0,  color: '#ffffff',  inner: false, radius: 0, overlay: 'frames/hachiware.png', photoArea: { x: 0.06, y: 0.17, w: 0.88, h: 0.65 }, showDate: true },
  { id: 'none',      name: 'ì—†ìŒ',       border: 0,  color: '#fff',    inner: false, radius: 0  },
  { id: 'white',     name: 'í™”ì´íŠ¸',     border: 40, color: '#ffffff',  inner: false, radius: 0  },
  { id: 'black',     name: 'ë¸”ë™',       border: 40, color: '#1a1a1a',  inner: false, radius: 0  },
  { id: 'polaroid',  name: 'í´ë¼ë¡œì´ë“œ', border: 0,  color: '#ffffff',  inner: false, radius: 0, polaroid: true },
  { id: 'pink',      name: 'í•‘í¬',       border: 35, color: '#ffd6e0',  inner: false, radius: 0  },
  { id: 'mint',      name: 'ë¯¼íŠ¸',       border: 35, color: '#c9f0e4',  inner: false, radius: 0  },
  { id: 'rounded',   name: 'ë¼ìš´ë“œ',     border: 30, color: '#ffffff',  inner: false, radius: 24 },
];

// â”€â”€ Init frames UI â”€â”€
(function initFrames() {
  const container = document.getElementById('frameSelector');
  frames.forEach((f, i) => {
    const el = document.createElement('div');
    el.className = 'frame-option' + (i === 0 ? ' selected' : '');
    el.dataset.frame = f.id;

    // Mini preview
    const preview = document.createElement('div');
    preview.className = 'frame-preview';
    if (f.polaroid) {
      preview.style.cssText = `background:#eee;border:3px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.15);border-bottom-width:10px;`;
    } else if (f.id === 'none') {
      preview.style.cssText = `background:#eee;border:2px dashed #ccc;border-radius:4px;`;
    } else if (f.overlay) {
      preview.style.cssText = `background:url(${f.overlay}) center/cover;border-radius:4px;`;
    } else {
      preview.style.cssText = `background:#eee;border:4px solid ${f.color};border-radius:${f.radius ? 6 : 2}px;box-shadow:0 1px 3px rgba(0,0,0,0.1);`;
    }
    preview.style.width = '40px';
    preview.style.height = '40px';

    const label = document.createElement('div');
    label.textContent = f.name;
    label.style.fontSize = '10px';
    label.style.marginTop = '4px';

    el.appendChild(preview);
    el.appendChild(label);
    el.onclick = () => selectFrame(f.id, el);
    container.appendChild(el);
  });
})();

// â”€â”€ Preload overlay images â”€â”€
const overlayImages = {};
frames.forEach(f => {
  if (f.overlay) {
    const img = new Image();
    img.src = f.overlay;
    overlayImages[f.id] = img;
  }
});

// â”€â”€ Navigation â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function goHome() {
  closeCamera();
  showScreen('homeScreen');
}

// â”€â”€ Camera â”€â”€
async function openCamera() {
  showScreen('cameraScreen');
  await startCamera();
}

async function startCamera() {
  try {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 3840 }, height: { ideal: 2880 } },
      audio: false
    });
    document.getElementById('videoPreview').srcObject = stream;
  } catch (e) {
    alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
    goHome();
  }
}

function closeCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  document.getElementById('videoPreview').srcObject = null;
}

async function switchCamera() {
  facingMode = facingMode === 'environment' ? 'user' : 'environment';
  await startCamera();
}

function capturePhoto() {
  const video = document.getElementById('videoPreview');
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = video.videoWidth;
  tempCanvas.height = video.videoHeight;
  const ctx = tempCanvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  closeCamera();

  const img = new Image();
  img.onload = () => {
    originalImage = img;
    renderCanvas();
    showScreen('editorScreen');
  };
  img.src = tempCanvas.toDataURL('image/jpeg', 0.95);
}

// â”€â”€ Upload â”€â”€
function openUpload() {
  document.getElementById('fileInput').click();
}

document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const img = new Image();
    img.onload = () => {
      originalImage = img;
      renderCanvas();
      showScreen('editorScreen');
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
});

// â”€â”€ Frame â”€â”€
function selectFrame(id, el) {
  document.querySelectorAll('.frame-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  currentFrame = id;
  renderCanvas();
}

// â”€â”€ Color â”€â”€
function selectColor(el) {
  document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
  textColor = el.dataset.color;
  renderCanvas();
}

// â”€â”€ Render canvas â”€â”€
function renderCanvas() {
  if (!originalImage) return;

  const canvas = document.getElementById('photoCanvas');
  const ctx = canvas.getContext('2d');
  const frame = frames.find(f => f.id === currentFrame) || frames[0];

  const imgW = originalImage.width;
  const imgH = originalImage.height;

  // Scale border relative to image size
  const scale = Math.min(imgW, imgH) / 500;
  const borderW = Math.round(frame.border * scale);

  let cw, ch, imgX, imgY;

  if (frame.overlay) {
    const overlayImg = overlayImages[frame.id];
    const pa = frame.photoArea;
    // Canvas = frame aspect ratio (507:758)
    const frameRatio = 507 / 758;
    // Use a reasonable canvas size
    cw = 1014;
    ch = 1516;
    canvas.width = cw;
    canvas.height = ch;
    // White background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, cw, ch);
    // Photo area within canvas
    const px = Math.round(cw * pa.x);
    const py = Math.round(ch * pa.y);
    const pw = Math.round(cw * pa.w);
    const ph = Math.round(ch * pa.h);
    // Scale photo to fill the photo area (crop to fit)
    const photoRatio = imgW / imgH;
    const areaRatio = pw / ph;
    let sx, sy, sw, sh;
    if (photoRatio > areaRatio) {
      sh = imgH;
      sw = Math.round(imgH * areaRatio);
      sx = Math.round((imgW - sw) / 2);
      sy = 0;
    } else {
      sw = imgW;
      sh = Math.round(imgW / areaRatio);
      sx = 0;
      sy = Math.round((imgH - sh) / 2);
    }
    // 1) Draw frame first (background + characters)
    if (overlayImg.complete) {
      ctx.drawImage(overlayImg, 0, 0, cw, ch);
    }
    // 2) Draw photo BEHIND frame characters using destination-over
    ctx.globalCompositeOperation = 'destination-over';
    ctx.drawImage(originalImage, sx, sy, sw, sh, px, py, pw, ph);
    // 3) Fill remaining area white (behind everything)
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, cw, ch);
    ctx.globalCompositeOperation = 'source-over';
    // Date stamp
    if (frame.showDate) {
      const now = new Date();
      const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
      const dateFontSize = Math.round(cw * 0.032);
      ctx.save();
      ctx.font = `${dateFontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
      ctx.textAlign = 'right';
      ctx.fillStyle = '#666';
      ctx.fillText(dateStr, cw * 0.92, ch * 0.95);
      ctx.restore();
    }
    imgX = px;
    imgY = py;
  } else if (frame.polaroid) {
    const side = Math.round(30 * scale);
    const top = Math.round(30 * scale);
    const bottom = Math.round(90 * scale);
    cw = imgW + side * 2;
    ch = imgH + top + bottom;
    imgX = side;
    imgY = top;
    canvas.width = cw;
    canvas.height = ch;
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,0.12)';
    ctx.shadowBlur = 20 * scale;
    ctx.shadowOffsetY = 4 * scale;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(-5, -5, cw + 10, ch + 10);
    ctx.restore();
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, cw, ch);
    ctx.drawImage(originalImage, imgX, imgY, imgW, imgH);
  } else {
    cw = imgW + borderW * 2;
    ch = imgH + borderW * 2;
    imgX = borderW;
    imgY = borderW;
    canvas.width = cw;
    canvas.height = ch;
    if (frame.id !== 'none') {
      ctx.fillStyle = frame.color;
      if (frame.radius) {
        roundRect(ctx, 0, 0, cw, ch, Math.round(frame.radius * scale));
        ctx.fill();
        ctx.save();
        roundRect(ctx, imgX, imgY, imgW, imgH, Math.round(frame.radius * scale * 0.6));
        ctx.clip();
        ctx.drawImage(originalImage, imgX, imgY, imgW, imgH);
        ctx.restore();
      } else {
        ctx.fillRect(0, 0, cw, ch);
        ctx.drawImage(originalImage, imgX, imgY, imgW, imgH);
      }
    } else {
      ctx.drawImage(originalImage, 0, 0, imgW, imgH);
    }
  }

  // Text
  const text = document.getElementById('textInput').value.trim();
  if (text) {
    const position = document.getElementById('textPosition').value;
    const fontSize = Math.round(Math.min(cw, ch) * 0.05);

    ctx.save();
    ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
    ctx.textAlign = 'center';
    ctx.fillStyle = textColor;
    ctx.strokeStyle = textColor === '#ffffff' ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.4)';
    ctx.lineWidth = Math.max(2, fontSize * 0.08);

    let tx = cw / 2;
    let ty;
    if (position === 'top') {
      ty = imgY + fontSize + 10 * scale;
    } else if (position === 'center') {
      ty = ch / 2;
    } else {
      // bottom
      if (frame.polaroid) {
        ty = imgY + imgH + ((ch - imgY - imgH) / 2) + fontSize * 0.35;
      } else {
        ty = imgY + imgH - fontSize * 0.5;
      }
    }

    ctx.strokeText(text, tx, ty);
    ctx.fillText(text, tx, ty);
    ctx.restore();
  }

  // Add date for polaroid at bottom area
  if (frame.polaroid && !text) {
    const now = new Date();
    const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
    const dateFontSize = Math.round(Math.min(cw, ch) * 0.032);
    ctx.save();
    ctx.font = `${dateFontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
    ctx.textAlign = 'center';
    ctx.fillStyle = '#999';
    const dateY = imgY + imgH + ((ch - imgY - imgH) / 2) + dateFontSize * 0.35;
    ctx.fillText(dateStr, cw / 2, dateY);
    ctx.restore();
  }

  // Brightness adjustment
  const brightness = parseInt(document.getElementById('brightnessRange').value);
  if (brightness !== 0) {
    const imgData = ctx.getImageData(0, 0, cw, ch);
    const d = imgData.data;
    const b = brightness * 2.55;
    for (let i = 0; i < d.length; i += 4) {
      d[i]     = Math.max(0, Math.min(255, d[i] + b));
      d[i + 1] = Math.max(0, Math.min(255, d[i + 1] + b));
      d[i + 2] = Math.max(0, Math.min(255, d[i + 2] + b));
    }
    ctx.putImageData(imgData, 0, 0);
  }
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// â”€â”€ Save â”€â”€
function savePhoto() {
  const canvas = document.getElementById('photoCanvas');
  const link = document.createElement('a');
  link.download = 'photo_' + Date.now() + '.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// â”€â”€ Print â”€â”€
async function printPhoto() {
  const btn = document.querySelector('.btn-primary[style]');
  const originalText = btn.textContent;
  btn.textContent = 'ì „ì†¡ ì¤‘...';
  btn.disabled = true;

  try {
    const canvas = document.getElementById('photoCanvas');
    const imageData = canvas.toDataURL('image/png');

    const jobId = Date.now().toString();
    const res = await fetch(SUPABASE_URL + '/rest/v1/print_jobs', {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal',
      },
      body: JSON.stringify({ id: jobId, image_data: JSON.stringify({ imageData }) }),
    });

    if (res.ok) {
      btn.textContent = 'í”„ë¦°íŠ¸ ìš”ì²­ ì™„ë£Œ!';
      btn.style.background = '#34c759';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.disabled = false;
        btn.style.background = '#34c759';
      }, 3000);
    } else {
      throw new Error('ì „ì†¡ ì‹¤íŒ¨');
    }
  } catch (e) {
    alert('í”„ë¦°íŠ¸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    btn.textContent = originalText;
    btn.disabled = false;
  }
}
</script>
</body>
</html>
